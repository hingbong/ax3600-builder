name: Build AX3600 NSS

on: 
  workflow_dispatch:
    inputs:
      openwrt_repository:
        required: true
        type: string
        default: "qosmio/openwrt-ipq"
      branch:
        required: true
        type: string
        default: "main-nss"
      openwrt_merge_requests:
        required: false
        type: string
        description: "Comma-separated list of OpenWrt PR numbers to apply as patches"
      openwrt_commit:
        required: false
        type: string
        description: "Comma-separated list of OpenWrt commit SHAs to cherry-pick"
      override_ath11k_makefile:
        required: false
        type: choice
        options:
          - "false"
          - "true"
        default: "false"
        description: "Set to 'true' to override package/firmware/ath11k-firmware/Makefile with the official one"
      ath11k_makefile_url:
        required: false
        type: string
        default: "https://raw.githubusercontent.com/openwrt/openwrt/main/package/firmware/ath11k-firmware/Makefile"
        description: "URL to fetch the official ath11k-firmware Makefile from"

jobs:
    build_and_release:
        name: Build and Release AX3600 NSS
        runs-on: ubuntu-latest
        permissions: write-all
        steps:
            - name: Install dependencies
              run: |
                sudo apt update
                sudo apt install -y \
                build-essential clang flex bison g++ gawk zstd \
                gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev \
                python3-setuptools rsync swig unzip zlib1g-dev file wget libelf-dev zlib1g-dev
                sudo apt full-upgrade -y
            - name: Maximize build space
              uses: easimon/maximize-build-space@master
              with:
                root-reserve-mb: 8192
                temp-reserve-mb: 2048
                remove-dotnet: 'true'
                remove-android: 'true'
                remove-haskell: 'true'
                remove-codeql: 'true'
            - name: show space
              run: |
                df -h
            - name: Checkout
              uses: actions/checkout@v4
              id: octokit
            - name: Pull OpenWrt source
              uses: actions/checkout@v4
              with:
                repository: ${{ inputs.openwrt_repository }}
                ref: ${{ inputs.branch }}
                path: openwrt
            - name: Optionally override ath11k Makefile
              if: ${{ inputs.override_ath11k_makefile == 'true' }}
              run: |
                set -e
                cd openwrt
                mkdir -p package/firmware/ath11k-firmware
                echo "Fetching ath11k Makefile from ${{ inputs.ath11k_makefile_url }}"
                curl -fsSL "${{ inputs.ath11k_makefile_url }}" -o package/firmware/ath11k-firmware/Makefile
                echo "Result:"
                ls -l package/firmware/ath11k-firmware/Makefile || true
            - name: Pull immortalwrt
              uses: actions/checkout@v4
              with:
                repository: immortalwrt/immortalwrt
                ref: master
                path: immortalwrt
            - name: Make cache paths
              run: |
                set -e
                cd openwrt
                git config --global user.name "${GITHUB_ACTOR}"
                git config --global user.email "${GITHUB_ACTOR}@users.noreply.github.com"
                ls $GITHUB_WORKSPACE/patches | xargs -I {} git apply -v $GITHUB_WORKSPACE/patches/{}

                git rev-parse --short HEAD > ../lastest-commit
                mkdir -p {dl,build_dir,staging_dir}
            - uses: actions/cache@v4
              name: Cache
              with:
                path: |
                  openwrt/dl
                  openwrt/build_dir
                  openwrt/staging_dir
                key: cache-key-${{ github.run_id }}
                restore-keys: |
                  cache-key
            - name: Prepare
              run: |
                set -e
                mv openwrt.sh openwrt
                cd openwrt

                # Apply OpenWrt PRs as patches
                if [ -n "${{ inputs.openwrt_merge_requests }}" ]; then
                  IFS=',' read -ra MR_LIST <<< "${{ inputs.openwrt_merge_requests }}"
                  for mr in "${MR_LIST[@]}"; do
                    echo "Applying OpenWrt PR #$mr"
                    curl -sL "https://github.com/openwrt/openwrt/pull/$mr.patch" | git am
                  done
                fi

                # Add upstream remote for cherry-picking from openwrt/openwrt
                git remote add upstream https://github.com/openwrt/openwrt.git
                git fetch upstream

                # Cherry-pick OpenWrt commits
                if [ -n "${{ inputs.openwrt_commit }}" ]; then
                  IFS=',' read -ra COMMIT_LIST <<< "${{ inputs.openwrt_commit }}"
                  for commit in "${COMMIT_LIST[@]}"; do
                    echo "Cherry-picking OpenWrt commit $commit"
                    git cherry-pick $commit
                  done
                fi

                bash openwrt.sh
                bash ../generate_hosts.sh
                echo '' >> package/base-files/files/etc/hosts
                cat generated_hosts.txt >> package/base-files/files/etc/hosts
                mkdir files
                ls $GITHUB_WORKSPACE/files/ | xargs -I "{}" cp -rf $GITHUB_WORKSPACE/files/{} files/
            - name: Firewall4 with Fullcone-nat
              run: |
                cd ${GITHUB_WORKSPACE}/openwrt/package/network/utils
                cp -r ${GITHUB_WORKSPACE}/immortalwrt/package/network/utils/fullconenat-nft .
                ls fullconenat-nft/*
                cd ${GITHUB_WORKSPACE}/openwrt/package/network/config/firewall4
                rm -rf *
                cp -r ${GITHUB_WORKSPACE}/immortalwrt/package/network/config/firewall4/* .
                ls */*

            - name: Update and install feeds
              run: |
                set -e
                cd openwrt
                ./scripts/feeds update -a
                ./scripts/feeds install -a
                cd feeds/luci
                ls $GITHUB_WORKSPACE/luci_patches | xargs -I {} git apply -v $GITHUB_WORKSPACE/luci_patches/{}
            - name: Download package sources
              run: |
                set -e
                mv .full_config openwrt/.config
                cd openwrt
                make defconfig V=s
            - name: Show config
              run: cat openwrt/.config
            - name: Build tools
              run: |
                cd openwrt
                make download V=s
                make tools/install -j $(nproc) V=s || \
                make tools/install V=s
            - name: Build toolchain
              run: |
                cd openwrt
                make toolchain/install -j $(nproc) V=s || \
                make toolchain/install V=s
            - name: Build target images
              run: |
                unset GITHUB_ACTIONS
                cd openwrt
                make -j $(nproc) V=s || \
                make V=s
            - name: Get revision
              run: |
                cd openwrt
                echo "Repository URL: $(git config --get remote.origin.url)" >> bodyFile
                echo "Git Reference: $(git rev-parse --abbrev-ref HEAD)" >> bodyFile
                echo "SHA: $(git log -1 --format='%H')" >> bodyFile
                echo "" >> bodyFile
                cat bin/targets/qualcommax/ipq807x/feeds.buildinfo >> bodyFile
                echo "" >> bodyFile

            # --- 合并后的发布步骤开始 ---
            - name: Prepare release files
              run: |
                # 将 config 文件复制到输出目录，方便作为 artifact 发布
                cp openwrt/.config openwrt/bin/targets/qualcommax/ipq807x/buildconfig
            
            - name: Get the current date
              run: echo "NOW=$(date +%F-%H%M)" >> $GITHUB_ENV

            - name: Create a release
              uses: "ncipollo/release-action@v1"
              with:
                name: "Updated prebuilt images ${{ env.NOW }}"
                tag: "ax3600-${{ env.NOW }}"
                makeLatest: true
                bodyFile: openwrt/bodyFile
                # 直接指向编译生成目录
                artifacts: openwrt/bin/targets/qualcommax/ipq807x/*
                token: "${{ secrets.GITHUB_TOKEN }}"
            # --- 发布步骤结束 ---

            - name: Clean for cache
              run: |
                cd openwrt
                make clean V=s
            - name: Cleanup old cache
              env:
                GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                gh extension install actions/gh-actions-cache
                REPO=${{ github.repository }}
                BRANCH=master

                echo "Fetching list of cache key"
                cacheKeysForPR=$(gh actions-cache list -R $REPO -B $BRANCH | cut -f 1 )

                ## Setting this to not fail the workflow while deleting cache keys. 
                set +e
                echo "Deleting caches..."
                for cacheKey in $cacheKeysForPR
                do
                   gh actions-cache delete $cacheKey -R $REPO -B $BRANCH --confirm
                done
                echo "Done"
